<?php
// setup.php - Hapus file ini setelah digunakan!

// Sembunyikan error di production
error_reporting(E_ALL);
ini_set('display_errors', 1);

echo "<!DOCTYPE html>
<html>
<head>
    <title>Setup e-Surat Desa</title>
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css' rel='stylesheet'>
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .card { margin-bottom: 20px; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <div class='container'>
        <div class='card'>
            <div class='card-header bg-primary text-white'>
                <h3>Setup Database e-Surat Desa</h3>
            </div>
            <div class='card-body'>";

// Koneksi database tanpa memilih database dulu
$host = 'localhost';
$username = 'root';
$password = '';

try {
    $pdo = new PDO("mysql:host=$host", $username, $password);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    
    // Buat database jika belum ada
    $pdo->exec("CREATE DATABASE IF NOT EXISTS esurat_desa");
    $pdo->exec("USE esurat_desa");
    
    echo "<div class='alert alert-success'>✓ Database berhasil dibuat/ditemukan</div>";
    
} catch(PDOException $e) {
    die("<div class='alert alert-danger'>✗ Koneksi database gagal: " . $e->getMessage() . "</div>");
}

// Buat tabel
$tables = [];

$tables[] = "CREATE TABLE IF NOT EXISTS penduduk (
    id INT PRIMARY KEY AUTO_INCREMENT,
    nik VARCHAR(20) UNIQUE NOT NULL,
    nama VARCHAR(100) NOT NULL,
    tempat_lahir VARCHAR(50) NOT NULL,
    tanggal_lahir DATE NOT NULL,
    alamat TEXT NOT NULL,
    no_telp VARCHAR(15),
    password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)";

$tables[] = "CREATE TABLE IF NOT EXISTS admin (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    nama VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)";

$tables[] = "CREATE TABLE IF NOT EXISTS kepala_desa (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    nama VARCHAR(100) NOT NULL,
    jabatan VARCHAR(100) DEFAULT 'Kepala Desa',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)";

$tables[] = "CREATE TABLE IF NOT EXISTS jenis_surat (
    id INT PRIMARY KEY AUTO_INCREMENT,
    kode_surat VARCHAR(10) UNIQUE NOT NULL,
    nama_surat VARCHAR(100) NOT NULL,
    template TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)";

$tables[] = "CREATE TABLE IF NOT EXISTS pengajuan_surat (
    id INT PRIMARY KEY AUTO_INCREMENT,
    penduduk_id INT NOT NULL,
    jenis_surat_id INT NOT NULL,
    keperluan TEXT NOT NULL,
    berkas_pendukung VARCHAR(255),
    status ENUM('menunggu', 'diproses', 'disetujui', 'ditolak', 'siap_ambil') DEFAULT 'menunggu',
    catatan_admin TEXT,
    nomor_surat VARCHAR(50),
    tanggal_pengajuan TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    tanggal_verifikasi TIMESTAMP NULL,
    tanggal_ttd TIMESTAMP NULL,
    FOREIGN KEY (penduduk_id) REFERENCES penduduk(id),
    FOREIGN KEY (jenis_surat_id) REFERENCES jenis_surat(id)
)";

foreach ($tables as $sql) {
    try {
        $pdo->exec($sql);
        echo "<div class='alert alert-success'>✓ Tabel berhasil dibuat</div>";
    } catch (PDOException $e) {
        echo "<div class='alert alert-danger'>✗ Error membuat tabel: " . $e->getMessage() . "</div>";
    }
}

// Generate hash password
$admin_hash = password_hash('admin123', PASSWORD_DEFAULT);
$kepala_hash = password_hash('kepala123', PASSWORD_DEFAULT);
$penduduk_hash = password_hash('123456', PASSWORD_DEFAULT);

// Insert data default
try {
    // Admin
    $stmt = $pdo->prepare("INSERT IGNORE INTO admin (username, password, nama) VALUES (?, ?, ?)");
    $stmt->execute(['admin', $admin_hash, 'Administrator Desa']);
    echo "<div class='alert alert-success'>✓ Admin berhasil dibuat (username: admin, password: admin123)</div>";
    
    // Kepala Desa
    $stmt = $pdo->prepare("INSERT IGNORE INTO kepala_desa (username, password, nama) VALUES (?, ?, ?)");
    $stmt->execute(['kepaladesa', $kepala_hash, 'Bapak Kepala Desa']);
    echo "<div class='alert alert-success'>✓ Kepala Desa berhasil dibuat (username: kepaladesa, password: kepala123)</div>";
    
    // Jenis Surat
    $jenis_surat = [
        ['S-001', 'Surat Keterangan Domisili'],
        ['S-002', 'Surat Keterangan Tidak Mampu (SKTM)'],
        ['S-003', 'Surat Keterangan Usaha'],
        ['S-004', 'Surat Keterangan Kelahiran'],
        ['S-005', 'Surat Keterangan Kematian']
    ];
    
    foreach ($jenis_surat as $surat) {
        $stmt = $pdo->prepare("INSERT IGNORE INTO jenis_surat (kode_surat, nama_surat) VALUES (?, ?)");
        $stmt->execute($surat);
    }
    echo "<div class='alert alert-success'>✓ Jenis surat berhasil dimasukkan</div>";
    
    // Contoh penduduk
    $stmt = $pdo->prepare("INSERT IGNORE INTO penduduk (nik, nama, tempat_lahir, tanggal_lahir, alamat, no_telp, password) VALUES (?, ?, ?, ?, ?, ?, ?)");
    $stmt->execute([
        '1234567890123456',
        'Budi Santoso',
        'Jakarta',
        '1990-01-15',
        'Jl. Merdeka No. 123',
        '081234567890',
        $penduduk_hash
    ]);
    echo "<div class='alert alert-success'>✓ Contoh penduduk berhasil dibuat (NIK: 1234567890123456, password: 123456)</div>";
    
    echo "<div class='alert alert-success'>
            <h4>Setup Berhasil!</h4>
            <p>Silahkan login dengan:</p>
            <ul>
                <li><strong>Admin:</strong> username: admin, password: admin123</li>
                <li><strong>Kepala Desa:</strong> username: kepaladesa, password: kepala123</li>
                <li><strong>Penduduk:</strong> NIK: 1234567890123456, password: 123456</li>
            </ul>
            <p><a href='index.php' class='btn btn-primary'>Ke Halaman Utama</a></p>
          </div>";
    
    echo "<div class='alert alert-warning'>
            <strong>PENTING:</strong> Hapus file setup.php ini dari server untuk keamanan!
          </div>";
    
} catch (PDOException $e) {
    echo "<div class='alert alert-danger'>✗ Error memasukkan data: " . $e->getMessage() . "</div>";
}

echo "</div></div></div></body></html>";
?>